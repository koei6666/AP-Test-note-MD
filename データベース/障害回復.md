データベースでは大きく分けて、「システム障害、トランザクション障害、媒体障害」の３種類の障害が発生する。
これらの障害から復旧し、一貫性を保たれた元の状態に戻すことを障害回復という。

### DBMSの仕組み
DBMSは通常、ディスクの入出力効率を向上するために、データをメモリ上にバッファリングしておき、データの更新はそのバッファに対して行う。
バッファに空きがなくなるなどの事象が発生する場合、バッファに保持されているデータをデータベースに書き出しする。
この仕組みのため、データはDBMS上では更新されているものの、そのデータがデータベースに反映されていないファイルが存在する可能性がある。

そのため、例えばデータ書き出しされる前に障害が発生した場合、整合性に問題が発生する可能性があるので、ロールバックが必要になる場合がある。
また、関連データすべてが更新された後、更新のタイミングでは整合性問題のないデータでも、その時点で障害発生した場合、更新確定(COMMIT)されたデータは書き出しされなく、ACID特性のDurability違反となるので、更新されたデータをデータベースに反映する必要がある。

### ログ
データベースのロールバックなどをするために、データベースない発生した更新の履歴を記録するログが必要なる。
ログはWAL Protocol(Write ahead log)に従って記録されている、データ変更する前にまずログで記録すると規定されている。
ログはこのような形で変更を記録している
\[更新、トランザクションID、データ名、更新前の値、更新後の値]

### システム障害からの復旧
#### redo/undo方式
システムの障害が発生する場合、DBMSが停止し、バッファに保存されているデータはすべて消失するので、システムリスタート後ログを使ってデータベースを復旧する。
この方式はredo/undo方式と呼ばれ、undoとは、COMMITされた以外の更新を、ログに記録された元の値を使って、データベースを更新前の状態に戻す。そしてredoはCOMMIT済みの更新をログの更新後の値を使ってデータベースを更新する。
この方式の発生としてno-undo/redo方式とno-redo/undo方式がある。

#### チェックポイントリスタート
[[システムの構成と信頼性設計#^e9b80e|ウォームスタート方式]]の一種として、チェックポイントリスタート方式がある。
DBMSはデータバッファとログバッファをデータベースに書き込みタイミングを設けている、このタイミングをチェックポイントと呼ばれる。

undo/redo方式では、システム起動時から障害発生時までのロッグが必要となり、ログをチェックしundo/redoするので、多くの時間が要する、そしてに対してチェックポイントリスタート方式では、障害直前のチェックポイントの状態から復旧することができるので、短時間に復旧することができる。

チェックポイントはCOMMITに同期して発生していない、トランザクションがCOMMITされても、データバッファにある内容はデータベースに書き出ししないだが、ログファイルの同期はCOMMITするたびに、およびチェックポイント発生時データベースに更新される。

チェックポイント発生時には、その時点実行中のトランザクション情報およびチェックポイント情報も書き出しされる。

チェックポイントリスタート後、チェックポイントから障害時発生したデータ更新の復旧は、以下の2つの処理がある：

| 処理名                      | 内容                                                                                                                                                                                                                                                         |
| --------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ロールバック(後退復帰)      | 障害発生した時点からチェックポイントまでのログファイルを逆方向で見ていき、COMMIT済み以外のトランザクションによる更新を、更新前情報を用いてundoする、そしてチェックポイント時点で実行中のトランザクションがあれば、そのトランザクションによる更新をundoする。 |
| ロールフォワード（前進復帰) | チェックポイントから正方向に見ていき、COMMIT済みのトランザクションにより更新を、更新後情報用いてredoする。                                                                                                                                                   |

### トランザクションによる障害
トランザクション障害は、トランザクションの不正中止（デッドロックにより強制中止、バッグなどによる異常終了)による,ACIDの原子性違反する障害。
このような障害が発生する場合は、原子性に従い、すべての変更をロールバックする。
すでにデータベースに書き出ししたデータでも、ログファイルの更新前データに合わせてロールバックする。

### 媒体障害からの回復

記憶媒体の故障により、データの読み出しができなくなる障害。
発生した場合は、バックアップファイルとログファイルで回復処理を行う。

バックアップファイルは以下の３種類がある：

| 名前             | 内容                                                                                                                                                                                                |
| ---------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| フルバックアップ | データベース全体をバックアップする                                                                                                                                                                  |
| 差分バックアップ | 直前のフルバックアップからの変更をバックアップする（例えばフルバックアップされたバージョン1があり、差分バックアップされたバージョン2,3...はすべてバージョン1からの変更をバックアップする。           |
| 増分バックアップ | 定期的にフルバックアップした上、次のフルバックアップまでの間、直前のバックアップからの変更をバックアップする(例えばフルバックアップされたバージョン1があり、バックアップバージョン2は1からの変更に対してにバックアップ、3は2からの変更に対してのバックアップ....)。バックアップ作業自体の時間は短くて済むが、復旧時では、フルバックアップを適用してから、差分バックアップを適用という流れになるので、フルバックアップ方式に比べると復旧に時間がかかる。|




#### RPO(Recovery Point Objective)
システム復旧時、障害発生前のどの時点の状態に復旧させるかの目標値、データ損失の最大許容範囲を意味する。

#### RTO(Recovery Time Objective)
障害発生時、どれぐらいの時間で復旧させるかの目標値、障害停止の最大許容時間を意味する。