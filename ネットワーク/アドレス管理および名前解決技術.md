### DHCP
ネットワーク内のノードにIPアドレスを自動的に割り当てるプロトコルをDHCPと呼ぶ。

DHCPサーバは利用できるアドレスを登録しておき、DHCPクライアントが起動するとDHCPサーバにDHCPDISCOVER要求を送信しDHCPサーバーを探索し（DHCPクライアントは事前にDHCPサーバーのIPアドレスを知らない）、IPアドレスを依頼する、そしてDHCPサーバは空いているIPアドレスをクライアントに割り当てをし、利用終了した後IPアドレスの回収まで行う。

DHCPサーバに対するDHCPDISCOVER依頼はクライアントがブロードキャストの形で送信するので、DHCPがブロードキャストに届かない場所（違うLANなど）に存在する場合は、アドレスを取得できないので、DISCOVER依頼をDHCPまで中継するリレーエージェント機能が必要になる。

#### DHCPの送信プロトコル
DHCPは、クライアント→サーバの通信には67/UDP、サーバ→クライアントの通信には68/UDPを使用します。
DHCPのシーケンス中でブロードキャストが使用されるためです。TCPはコネクション型で相手との接続を確立してから通信を行う特性があり、不特定多数の相手を宛先とするブロードキャストやマルチキャストができません。このためDHCPではUDPが使用されているという訳です。

#### DHCPメッセージ
DHCPサーバとクライアントのやり取りは以下のメッセージとなる
- DHCPクライアントがネット上のDHCPサーバを探すため、DHCPDISCOVER依頼をブロードキャストの形で送信
- DHCPサーバが提供できるIPアドレスなどのネットワーク設定情報をDHCPクライアントに通知するため、DHCPOFFERを送信
- DHCPクライアントはネットワークの設定情報の使用要求をサーバに連絡するため、DHCPREQUESTを送信
- DHCPサーバはネットワークの設定情報の使用要求を認めたことをクライアントに伝えベク、DHCPACKを送信
##### 複数DHCPサーバが存在する場合
同じネットワークにDHCPサーバが複数存在する場合はクライアントが送信したDHCP DISCOVERに対して複数のDHCP OFFERが返されます。クライアントはこのうち先に受信したものを優先し、受け入れを表明するために、そのDHCP OFFERに含まれる「送信元DHCPサーバのIPアドレス」と「提案されたIPアドレス」を格納したDHCP REQUESTをブロードキャストします。  
DHCP REQUESTを受信したDHCPサーバはパケット内容を確認し、自身の提案が受けれられたならばDHCP ACKで構成情報をクライアントに通知します。そうでなければ自身の提案が破棄されたと判断しDHCP REQUESTを無視します。要するにDHCPサーバがDHCP REQUESTの内容から判断できることは、自身のDHCP OFFERがクライアントで受理されたかどうかという点です。

#### DHCPリレーエージェント
DHCPDISCOVERとDHCPREQUESTメッセージがブロードキャストで行われる関係で、DHCPクライアントとDHCPサーバが異なるセグメントに設置されているときにはDHCPによるネットワーク情報の割当てが正しく動作しません。  
  
この問題を解決するためにルータやL3SWで稼働させるのが、**DHCPリレーエージェント**です。DHCPリレーエージェントは、==異なるネットワークセグメントに存在する==（ブロードキャストが届かない）DHCPクライアントとDHCPサーバとの間の通信を取り持つことでDHCPを機能させるものです。本問のようにTCとDHCPサーバが別のセグメントに設置されている場合には、DHCPリレーエージェントを利用する必要があります。
![[Pasted image 20240110232808.png]]

### DHCPリース期間
DHCPのリース期間は、DHCPサーバが割り当てたIPアドレスを利用することができる期間です。延長要求がないままリース期間を過ぎるとそのIPアドレスは回収されて、新たに割り当て対象のIPアドレスとなり、他のDHCPクライアントに割り当てられます。同じIPアドレスを使いまわすので、使用するIPアドレス数が少なくて済みます。

![[DNS]]

## コンテンツサーバとキャッシュサーバ

DNS（Domain Name System）にはさまざまな種類のサーバーがありますが、その中でも特に重要な役割を果たすのは**コンテンツサーバ（Authoritative Name Server）**と**キャッシュサーバ（Caching or Recursive Name Server）**です。

### **コンテンツサーバ（Authoritative Name Server）**

- **役割**: コンテンツサーバは特定のドメイン（例えば、`example.com`）に関する情報を「権威ある」形で保持しています。このサーバーは、そのドメインに関する質問（クエリ）に対して答える「公式な」情報源です。
- **情報の種類**: 
　- Aレコード（IPv4アドレス）
　- AAAAレコード（IPv6アドレス）
　  ドメイン名・ホスト名に対応するIPアドレスを指定するためのレコードです。
　- MXレコード（メールサーバー）
　- NSレコード（DNSサーバを指定）：
　  _そのドメインのゾーン情報を保持するネームサーバのホスト名を指示するレコードです_。NSレコードは1つ以上記述することができ、1番上に設定されたネームサーバーが優先DNSサーバ、2つ目以降のネームサーバーは、優先DNSサーバが不存在や障害などの場合にアクセスする代替DNSサーバとなります。
　- CNAMEレコード（ホストの別名を指定）
　  あるホスト名に対して別名(エイリアス)を指定するレコードです。
　  
- **実世界の例**: Googleのドメイン`google.com`に対する情報は、Googleが管理する権威あるDNSサーバーに格納されています。
- **主な機能**: 名前解決の最終的な答えを提供する。
  
### **キャッシュサーバ（Caching or Recursive Name Server）**

- **役割**: キャッシュサーバは、エンドユーザーからのDNSクエリを受け取り、その回答を見つけ出す責任があります。見つけた回答は一定期間キャッシュ（保存）され、同じ質問がすぐに再度行われた場合には、キャッシュから直接回答を提供できます。
- **動作の手順**: 
  1. キャッシュサーバはまず**ローカルのキャッシュ**を調べる。
  2. キャッシュに情報がない場合、必要に応じて他のDNSサーバー（最終的にはコンテンツサーバ）にクエリを行い、その回答を得る。
  3. 得られた回答をエンドユーザーに返し、一定期間**キャッシュに保存**する。
- **実世界の例**: インターネットサービスプロバイダー（ISP）が顧客にDNS解決サービスを提供する際に使われるDNSサーバがこれに該当します。

### **相互の関係**

キャッシュサーバはエンドユーザーからのクエリに応じて、必要な情報を探す役割があります。そのため、コンテンツサーバにクエリを送ることがよくあります。コンテンツサーバが回答を提供すると、キャッシュサーバはその情報をキャッシュに保存し、エンドユーザーにその情報を返します。

**コンテンツサーバ**が保持する情報は**正確で権威ある**ものであり、**キャッシュサーバ**はその情報を**一時的に保存**して効率を高める役割があります。両者は連携して、インターネットの名前解決システムを高速かつ効率的に機能させています。

#### ダイナミックDNS
**ダイナミックDNS**は、インターネット接続の度に動的に割り振られるIPアドレスとそのホスト名の対応を動的に管理する仕組みです。  
  
常時接続環境ではインターネット接続の度にDHCPからグローバルIPアドレスが割り振られるため、個人が自宅サーバを公開するときにホスト名とIPアドレスの対応をとることができないという問題が生じます。ダイナミックDNSでは、この問題に対応するために接続がある度(IPアドレスが割り振られる度)にIPアドレス・ホスト名対応情報の登録・更新をDNSサーバへ行います。これによって固定IPアドレスがない環境でも常に同じホスト名でアクセスさせることができるようになります。