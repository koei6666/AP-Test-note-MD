
File Transfer Protocol
ファイル送受信に用いるファイル転送プロトコル
ファイルをダウンロードする機能（データコネクション）とコマンドを送受信する機能は別のポートを使用する。

## 転送モード

FTPは主に、アクティブモードとパッシブモードの接続モードがある。

#### アクティブモード
サーバがクライアントへ接続をトライする方式
特徴:
　- 制御接続開始: クライアント
　  制御接続開始後、クライアントがデータ転送ポートを指定する
　 - 接続トライ:サーバがクライアントの指定したポートに接続をトライする
　 - Income packetを受信する必要があるため、FWにブロックされる可能性がある

パケットログの特徴:
```
11:20:15 ALLOW TCP 192.168.1.10:46789 -> 203.0.113.5:21
11:20:16 ALLOW TCP 192.168.1.10:46789 <- 203.0.113.5:21
11:20:17 ALLOW TCP 203.0.113.5:20 -> 192.168.1.10:12345
11:20:18 ALLOW TCP 192.168.1.10:12345 <- 203.0.113.5:20
```

1.制御接続:
クライアントからサーバへ、TCP:21(FTP)のポートで制御接続を開始する。
```
11:20:15 ALLOW TCP 192.168.1.10:46789 -> 203.0.113.5:21
11:20:16 ALLOW TCP 192.168.1.10:46789 <- 203.0.113.5:21
```

2.接続開始:
サーバから(通常)TCP:20でクライアントの指定ポート(高番ポート)に接続
制御接続とデータ転送接続は別々で確立されるという特徴がみられる
```
11:20:17 ALLOW TCP 203.0.113.5:20 -> 192.168.1.10:12345
11:20:18 ALLOW TCP 192.168.1.10:12345 <- 203.0.113.5:20
```

#### パッシブモード
サーバがクライアントからの接続を待ってデータ転送接続を確立する方式
特徴:
　- 制御接続開始:クライアント
　  アクティブモードとは違って、この段階ではクライアントが制御接続開始後、そのままサーバにデータ転送接続を確立するので、特にサーバに対してポート指定などはしない。
　- Outgoing packetでデータ転送接続を確立するので、ステートフルインスペクション型のFWでも通過できる

パケットログの特徴:
```
10:15:30 ALLOW TCP 192.168.1.10:45678 -> 203.0.113.5:21
10:15:31 ALLOW TCP 192.168.1.10:45679 -> 203.0.113.5:50100
10:15:32 ALLOW TCP 192.168.1.10:45679 <- 203.0.113.5:50100
```

1.制御接続:
```
10:15:30 ALLOW TCP 192.168.1.10:45678 -> 203.0.113.5:21
```
クライアントの高番TCPポートからサーバのTCP:21番に制御接続を確立

2.接続開始
```
10:15:31 ALLOW TCP 192.168.1.10:45679 -> 203.0.113.5:50100
10:15:32 ALLOW TCP 192.168.1.10:45679 <- 203.0.113.5:50100
```
データ転送接続は、制御接続確立後(クライアントが`PASV`コマンドをサーバに送信)、サーバはそれに対する返信で、指定する接続先のポート番号をクライアントに返信する。
クライアントが制御接続とは別のポートから、サーバに指定されたポート番号に接続し、パケット転送接続を確立する。