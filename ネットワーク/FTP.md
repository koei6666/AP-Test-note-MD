
File Transfer Protocol
ファイル送受信に用いるファイル転送プロトコル
ファイルをダウンロードする機能（データコネクション）とコマンドを送受信する機能は別のポートを使用する。

## 転送モード

FTPは主に、アクティブモードとパッシブモードの接続モードがある。

#### アクティブモード
サーバがクライアントへ接続をトライする方式
特徴:
　- 制御接続開始: クライアント
　  制御接続開始後、クライアントがデータ転送ポートを指定する
　 - 接続トライ:サーバがクライアントの指定したポートに接続をトライする
　 - Income packetを受信する必要があるため、FWにブロックされる可能性がある

パケットログの特徴:
```
# Active Mode FTP Transfer 
# Client IP: 192.168.1.100, Port: 1234 
# Server IP: 10.0.0.5, Port: 21 (Control), Port: 20 (Data) 

# Control Channel Connection 
16:20:15.123 192.168.1.100:1234 -> 10.0.0.5:21 TCP SYN 

16:20:15.124 10.0.0.5:21 -> 192.168.1.100:1234 TCP SYN-ACK 

16:20:15.125 192.168.1.100:1234 -> 10.0.0.5:21 TCP ACK 


# FTP Commands and Responses 
16:20:15.126 10.0.0.5:21 -> 192.168.1.100:1234 220 FTP Server Ready 

16:20:15.127 192.168.1.100:1234 -> 10.0.0.5:21 USER anonymous 

16:20:15.128 10.0.0.5:21 -> 192.168.1.100:1234 331 Password required 

16:20:15.129 192.168.1.100:1234 -> 10.0.0.5:21 PASS anonymous@example.com 

16:20:15.130 10.0.0.5:21 -> 192.168.1.100:1234 230 Login successful 


# Active Mode Data Transfer 
16:20:15.131 192.168.1.100:1234 -> 10.0.0.5:21 PORT 192,168,1,100,10,21 

16:20:15.132 10.0.0.5:21 -> 192.168.1.100:1234 200 PORT command successful 

16:20:15.133 192.168.1.100:1234 -> 10.0.0.5:21 RETR example.txt 

16:20:15.134 10.0.0.5:21 -> 192.168.1.100:1234 150 Opening data connection 

16:20:15.135 10.0.0.5:20 -> 192.168.1.100:2581 TCP SYN (Data Channel) <- Key Line to determine whether its ACTV or PASV

16:20:15.136 192.168.1.100:2581 -> 10.0.0.5:20 TCP SYN-ACK 

16:20:15.137 10.0.0.5:20 -> 192.168.1.100:2581 TCP ACK # Data transfer occurs 

16:20:15.238 10.0.0.5:21 -> 192.168.1.100:1234 226 Transfer complete
```

##### 1.制御接続:(ACTV)
クライアントからサーバへ、TCP:21(FTP)のポートで制御接続を開始する。
```
16:20:15.123 192.168.1.100:1234 -> 10.0.0.5:21 TCP SYN 

16:20:15.124 10.0.0.5:21 -> 192.168.1.100:1234 TCP SYN-ACK 

16:20:15.125 192.168.1.100:1234 -> 10.0.0.5:21 TCP ACK 
```

##### 2.接続開始:(ACTV)
パスワードなどで認証成功した後、クライアントは`PORT`指令で指定の接続ポートをサーバに連絡。
**サーバから(通常)==TCP:20==でクライアントの==指定ポート(高番ポート)==に接続**
制御接続とデータ転送接続は別々で確立されるという特徴がみられる
```
16:20:15.131 192.168.1.100:1234 -> 10.0.0.5:21 PORT 192,168,1,100,10,21 

16:20:15.132 10.0.0.5:21 -> 192.168.1.100:1234 200 PORT command successful 

16:20:15.135 10.0.0.5:20 -> 192.168.1.100:2581 TCP SYN (Data Channel) 

```

#### パッシブモード
サーバがクライアントからの接続を待ってデータ転送接続を確立する方式
特徴:
　- 制御接続開始:クライアント
　  アクティブモードとは違って、この段階ではクライアントが制御接続開始後、そのままサーバにデータ転送接続を確立するので、特にサーバに対してポート指定などはしない。
　- Outgoing packetでデータ転送接続を確立するので、ステートフルインスペクション型のFWでも通過できる

パケットログの特徴:
```
# Passive Mode FTP Transfer 
# Client IP: 192.168.1.100, Port: 1235 
# Server IP: 10.0.0.5, Port: 21 (Control) 
# Control Channel Connection 

16:25:20.123 192.168.1.100:1235 -> 10.0.0.5:21 TCP SYN 

16:25:20.124 10.0.0.5:21 -> 192.168.1.100:1235 TCP SYN-ACK 

16:25:20.125 192.168.1.100:1235 -> 10.0.0.5:21 TCP ACK 


# FTP Commands and Responses 
16:25:20.126 10.0.0.5:21 -> 192.168.1.100:1235 220 FTP Server Ready 

16:25:20.127 192.168.1.100:1235 -> 10.0.0.5:21 USER anonymous 

16:25:20.128 10.0.0.5:21 -> 192.168.1.100:1235 331 Password required 

16:25:20.129 192.168.1.100:1235 -> 10.0.0.5:21 PASS anonymous@example.com 

16:25:20.130 10.0.0.5:21 -> 192.168.1.100:1235 230 Login successful 

# Passive Mode Data Transfer 
16:25:20.131 192.168.1.100:1235 -> 10.0.0.5:21 PASV 

16:25:20.132 10.0.0.5:21 -> 192.168.1.100:1235 227 Entering Passive Mode (10,0,0,5,157,23) 

16:25:20.133 192.168.1.100:1235 -> 10.0.0.5:21 RETR example.txt 

16:25:20.134 10.0.0.5:21 -> 192.168.1.100:1235 150 Opening data connection 

16:25:20.135 192.168.1.100:1236 -> 10.0.0.5:40215 TCP SYN (Data Channel) <- Client's high numbered port connected to server's high numbered port, different fro ACTV mode

16:25:20.136 10.0.0.5:40215 -> 192.168.1.100:1236 TCP SYN-ACK 

16:25:20.137 192.168.1.100:1236 -> 10.0.0.5:40215 TCP ACK # Data transfer occurs 

16:25:20.238 10.0.0.5:21 -> 192.168.1.100:1235 226 Transfer complete
```

##### 1.制御接続:(PASV)
```
16:25:20.123 192.168.1.100:1235 -> 10.0.0.5:21 TCP SYN 

16:25:20.124 10.0.0.5:21 -> 192.168.1.100:1235 TCP SYN-ACK 

16:25:20.125 192.168.1.100:1235 -> 10.0.0.5:21 TCP ACK 
```
クライアントの高番TCPポートからサーバのTCP:21番に制御接続を確立

##### 2.接続開始(PASV)
```
16:25:20.131 192.168.1.100:1235 -> 10.0.0.5:21 PASV 

16:25:20.132 10.0.0.5:21 -> 192.168.1.100:1235 227 Entering Passive Mode (10,0,0,5,157,23) 

16:25:20.135 192.168.1.100:1236 -> 10.0.0.5:40215 TCP SYN (Data Channel) 

16:25:20.136 10.0.0.5:40215 -> 192.168.1.100:1236 TCP SYN-ACK 
```
データ転送接続は、制御接続確立後(クライアントが`PASV`コマンドをサーバに送信)、サーバはそれに対する返信で、指定する接続先のポート番号をクライアントに返信する。
クライアントが制御接続とは別のポートから、サーバに指定されたポート番号に接続し、パケット転送接続を確立する。
クライアントの高番ポートからサーバの項番ポートに接続が確立されるのが特徴。