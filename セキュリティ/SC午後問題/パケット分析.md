---
出題年: 平成21年
tags:
  - DNSリフレクター攻撃
  - DNSアンプ攻撃
  - パケット分析
---
![[Pasted image 20240714120718.png]]
パケットモニタYには、DNSクエリとそれに対応するDNSクエリレスポン スが多量に記録されていました。しかし、パケットモニタZには、DNSクエ リを伴わないDNSクエリレスポンスが多量に記録されていました。パケット モニタZのログを図3に示します。
![[Pasted image 20240714120749.png]]
J主任：このようなログは、社内LAN上のPCがDNSクエリを送信するときに自身 のIPアドレスを［ b ］のIPアドレスに［ c ］した場合に記録さ れます。

>[!問b、c]
>(2) 本文中の b に入れる適切な字句を解答群の中から選び、記号で答えよ。また、本文中の c に入れる適切な字句を、5字以内で答えよ。
>bに関する解答群: 
> - ア DMZ上のDNSサーバ　
> - イ DMZ上のWebサーバ 
> - ウ インターネット上
> **正解：**
> ウ、図３の詳細部分から、パケットモニターZは DMZのDNSサーバが送信したDNS Query responseのトラフィックを捕獲しているが、それの問い合わせ受信した履歴を捕獲してないことがわかる。この現象はDNS レフレクター攻撃の現象（次問回答DNS reflectionとわかる）なので、bにはまずイを排除することができる（今回の事象はWebサーバと直接関係がなかったので）。
> 次に回答をアかウの中から考える、まずパケットモニターがネットワークに設置された位置を確認すると、FWとルータの間になるので、社内ネットワークから出るすべてのトラフィックを捕獲できるはずが、DNS Queryを受信した履歴がないということは、そのQueryは社内から送付されたとわかる、またqueryの返信先はインターネット上のアドレスから、社内の端末が自分のアドレスをインターネット上のアドレスに偽装（詐称）「c：詐称」し、DMZ上のDNSサーバに大量なqueryを送信し、それをリフレクターとして利用しインターネット上のアドレスを攻撃しているとわかるので。
> 正解はウ、詐称


K君：不正なDNSクエリが多量にDMZ上のDNSサーバに送りつけられたこと で、Webページを閲覧するときの応答が遅くなったのですね。確かに、すべ ての社内PCからの名前解決を、DMZ上のDNSサーバが担っていますから。

J主任：こういった通信は［ d ］攻撃と呼ばれています。至急、不正なパケッ トを棄却する設定をすべての部門のルータに適用してください。

>[!問d]
>
>(3) 本文中の d に入れる適切な字句を解答群の中から選び、記号で答えよ。
>解答群 
>ア DNS cache poisoning　
>イ DNS reflection 
>ウ 総当たり　
>エ ファーミング
>正解：イ


K君：はい、分かりました。

J主任：こうした事象は、ウイルス感染によってよく引き起こされます。今回の事象以外にも、異常な通信が観測される可能性があります。社内LANに接続され ているすべての部門のルータにパケットモニタを設置して、原因となってい る社内PCを特定してください。

K君：ルータへの設定が終わり次第、パケットモニタによる調査を開始します。

J主任：ところで、図3中の［ e ］と［ f ］の記録から、DMZ上のDNS サーバが攻撃の踏み台に利用される危険性があることが分かります。①<u>DNS サーバの不適切な設定も修正しておくべきですね。</u>

>[!問e,f]
>問eに関して、まずDMZ上のDNSサーバは基本的に社内からのDNS query（社外からでは社内ドメインのアドレスを解決のみ）を解決することから、IはDNSサーバから問い合わせを回答したを示すだけなので問題はなく、IIには、社外（インターネットのアドレス）に問い合わせを返信した履歴になるので、 DMZ DNSの役割としてあるべきではない振る舞いになるので不正になる。
>問fに関しては、問eと分けて考える必要がある、まずIIIに関しては、問い合わせ失敗を返信しただけなので、 DMZ DNZの役割から超えていない。IVに関しては、社内のIPアドレスを回答し、しかも同じくDMZ内のアドレスを回答しているので、DNSサーバとしては不正ではない（社内DMZ以外の内部アドレスをインターネットに回答した場合は要注意）。そして残りはVになる、Vは社内DNSの役割以外に、インターネットのアドレスをほかのインターネットアドレスに回答したため、不正行為になる。

>[!下線①の修正内容]
>前問から、DMZ DNSサーバの役割は社内からのDNS query解決と社外からのDMZ WEBサーバに対したqueryの解決と分かったので、修正の内容は社外からの問い合わせには自社外のドメインに対する問い合わせを拒否するとすれば解決できる

K君は社内LANに接続されたすべての部門のルータの配下にパケットモニタを設置して、異常な通信の監視を開始した。
![[Pasted image 20240714132854.png]]
K君 :図4がα部門に設置したパケットモニタのログです。

J主任 :<u>②図4中の(VI)に示した箇所に,通常の社内PCには見られない不審な通信挙動が記録されていますね。</u>これは［ g ］におけるアドレス探索に見られる特徴です。また,図4中の(VII)に示した箇所にも,不審な通信挙動が記録されていますね。(VII)に示す通信によって,<u>③通信の異常な偏りが発生します。</u>

>[!下線部②]
>不審な挙動は、車内にあるIPアドレスが社内のDNSサーバーを利用せずに3つのDNSサービスも利用して、異なる社外のメールサービスアドレスを問い合わせしている（MX）、これを30字以内にまとめると：社外DNS3つに異なる社外メールサーバを問い合わせした

>[!問g]
>社外のメールサーバを探索していることから、迷惑メール送信するに利用するメールサーバを当てていることがわかる、なので、迷惑メールの送信が正解とわかる。

K君 :なるほど。a1.a2.a3.a4に該当する社内PCが,原因となっているPCですね。

J主任 :こうした視点で,ほかの部門に設置したパケットモニタのログも確認してみましょう。

......

J主任とK君は,全部門のパケットモニタのログを調べた結果,IPアドレスがa1.a2.a3.a4のログだけに異常が見られたことから,このIPアドレスのPCへの対処を開始した。この対処として,通信プロセス名,実行ファイル名,通信のあて先のIPアドレスとポート番号を記録する通信プロセスモニタを,該当するPCに設定して監視を行った。

K君 :該当するPCに設定した通信プロセスモニタのログから,起動していた<u>④不審な通信プロセスを特定でき,それがウイルスであることが分かったので,その実行ファイルを削除しておきました。</u>このPCではウイルス対策ソフトが起動しており,そのパターンファイルの自動更新も設定されていました。検知できないウイルスもあるのですね。

>[!下線部④、どのような挙動をしているプロセスを探すか？]
>通常社内の端末では通信しない社外ホストに連続して通信するプロセス


......
K君 :該当するPCにログインしたまま1日間操作しないで通信状況を監視したところ,DNSパケットだけでなくすべてのTCP/UDPパケットの発信が止まったことを確認しました。

J主任 :それは変ですね。当社の設定では,操作しないPCでもPCにログインしていれば,<u>⑤TCP/UDPパケットは自動的に発信されます。hostsファイルが改ざんされているのではないでしょうか。</u>

K君 :図5がhostsファイルです。確かに,ウイルス対策ソフトのパターンファイルの配布サイト情報が追加されているようです。

![[Pasted image 20240714154454.png]]

>[!下線部⑤、通常では端末が何のTCP/UDPパケットが観測されるか]
>前後文から、社内のPCには自動的にウィルスのパターンファイルを更新するようにと設定されているとわかる、パケットはパターンファイルを通信するトラフィックと基本的に断定することができるが、それを裏付けるために下を見ると、改ざんされたHostsファイルのパターンファイル配布サイトが自分に差していると改ざん（127.0.0,1)されていることから、ウィルスの影響でこの通信ができなくなったという事象と組み合わせて、本来通信があるべきだったのは、ウィルス対策ソフトのパターン更新通信であることがわかる。

