---
tags:
  - Linux
---

tarコマンドは、Linuxやその他のUNIX系オペレーティングシステムで広く使用されるファイルアーカイブユーティリティです。以下にtarコマンドの主な特徴と使用方法を簡潔に説明します：

1. 機能：
   - 複数のファイルやディレクトリを1つのアーカイブファイルにまとめる
   - アーカイブファイルから元のファイルやディレクトリを抽出する

2. 名前の由来：
   "tar"は"Tape Archive"の略で、元々は磁気テープへのバックアップ用に開発されました。

3. 基本的な使い方：
   - アーカイブの作成: `tar -cvf archive.tar files/`
   - アーカイブの抽出: `tar -xvf archive.tar`

4. 主なオプション：
   - c: アーカイブを作成
   - x: アーカイブを展開
   - v: 詳細な出力を表示（verbose）
   - f: アーカイブファイル名を指定
   - z: gzipで圧縮/展開（.tar.gzファイル用）
   - j: bzip2で圧縮/展開（.tar.bz2ファイル用）

5. 圧縮との組み合わせ：
   tarは単独では圧縮を行いませんが、gzipやbzip2などの圧縮ツールと組み合わせて使用できます。

### 任意コマンドを実行できる危険性

#### to-command
tarの任意コマンドを実行するオプションは `--to-command` または短縮形の `-to-command` です。このオプションを使用すると、アーカイブから抽出される各ファイルに対して指定したコマンドを実行できます。

主な特徴と使用方法は以下の通りです：

1. 構文:
   ```
   tar -xf archive.tar --to-command=COMMAND
   ```

2. 機能:
   - アーカイブから抽出される各ファイルの内容が、指定されたコマンドの標準入力に渡されます。
   - ファイル名は環境変数 `TAR_FILENAME` として利用可能です。
   - ファイルのサイズは環境変数 `TAR_FILESIZE` として利用可能です。

3. 使用例:
   ```
   tar -xf archive.tar --to-command='grep "pattern" > "$TAR_FILENAME.filtered"'
   ```
   この例では、アーカイブ内の各ファイルに対して `grep` コマンドを実行し、結果を元のファイル名に ".filtered" を付けて保存します。

4. 注意点:
   - このオプションは、アーカイブの内容を直接処理したい場合や、抽出と同時に何らかの操作を行いたい場合に特に有用です。
   - セキュリティ上の理由から、信頼できないアーカイブに対してこのオプションを使用する際は注意が必要です。

5. 応用:
   - ファイルの内容を変換する
   - 特定の条件に合うファイルのみを抽出する
   - アーカイブの内容を分析する

#### checkpoint-action
`--checkpoint-action` オプションは、tarコマンドの処理中に特定のチェックポイントで指定したアクションを実行するためのものです。これは主に大きなアーカイブを扱う際の進捗管理や、長時間実行されるtar操作のモニタリングに役立ちます。

以下に、`--checkpoint-action` オプションの主な特徴と使用方法を説明します：

1. 基本構文:
   ```
   tar [operation] --checkpoint=ЧИСЛА --checkpoint-action=ACTION archive.tar files
   ```

2. 関連オプション:
   - `--checkpoint=N`: Nファイルごとにチェックポイントを設定します。
   - `--checkpoint-action=ACTION`: 各チェックポイントで実行するアクションを指定します。

3. 主なアクション:
   - `echo=文字列`: 指定した文字列を表示します。
   - `exec=コマンド`: 指定したコマンドを実行します。
   - `ttyout=文字列`: 文字列をTTY（端末）に出力します。

4. 使用例:
   ```
   tar -cf archive.tar --checkpoint=100 --checkpoint-action=echo="Processed %{pos} bytes..." /path/to/files
   ```
   この例では、100ファイルごとに処理したバイト数を表示します。

5. 複数のアクションの指定:
   複数のアクションを指定する場合は、`--checkpoint-action` オプションを繰り返し使用します。

6. 環境変数:
   アクション内で使用可能な主な環境変数:
   - `%{pos}`: 現在の位置（バイト数）
   - `%{totsize}`: アーカイブの合計サイズ（推定値）

7. 応用例:
   ```
   tar -cf archive.tar --checkpoint=1000 --checkpoint-action=echo="Checkpoint reached" --checkpoint-action=exec='date "+%T"' /path/to/files
   ```
   この例では、1000ファイルごとにメッセージを表示し、現在時刻を出力します。

[[Linuxの任意コード実行できるコマンドへの対策]]